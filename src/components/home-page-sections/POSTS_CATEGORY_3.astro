---
import type { CategoryObject, Sectionable } from '~/api/api';
import PressReleasesCard from '~/components/PressReleasesCard.astro';
import { ExtractImagesFromMedia, prepareContentFromJsonOrHTMLString } from '~/utils/utils';
import Action from './Action.astro';

const locale = Astro.currentLocale || 'ar';
const { section } = Astro.props;
const category = section?.sectionables?.find((sectionable) => sectionable.sectionable_type === 'App\\Models\\Category');
if (!category) {
  return null;
}
const posts = ((category as Sectionable)?.sectionable as CategoryObject).posts || [];
const allLink = section?.sectionables?.find(
  (sectionable) => {
    return sectionable.sectionable_type === ('App\\Models\\Action');
  }
);
const postsData = posts.map((post) => ({
  img: ExtractImagesFromMedia(post.media)?.[0]?.original_url,
  id: post?.id,
  link: post?.link ? post.link : `/${locale}/post/${post?.id}`,
  title: post?.title[locale] || post?.title['ar'],
  desc: prepareContentFromJsonOrHTMLString(post?.description[locale], locale, true),
  short_desc:
    prepareContentFromJsonOrHTMLString(
      post?.short_description[locale] || post?.description[locale],
      locale,
      true
    ).substring(0, 200) + '...',
}));
if (!posts || posts.length === 0) {
  return null;
}
---

<div class="text-start bg-white dark:bg-page py-[90px] xl:py-[134px] main-padding mb-16">
  <h2 class="text-primary-light text-4xl capitalize font-[600] text-center xl:text-[64px]">
    <a href={`${locale}/category/${category.id}`}>
      {section.title[locale] || section.title['ar']}
    </a>
  </h2>
  <p class="text-[#ABABAB] capitalize max-w-[70ch] text-balance mx-auto xl:text-2xl mt-3 text-center">
    {section.description[locale] || section.description['ar']}
  </p>

  <div class="carousel-press mt-28">
    {
      postsData?.map((item) => {
        return (
          <div class={`carousel-cell w-full lg:w-1/2 xl:w-1/3 lg:pe-6`}>
            <PressReleasesCard {...item} />
          </div>
        );
      })
    }
  </div>
  {
    allLink?.sectionable?.link && allLink?.sectionable?.label?.[locale] && (
      <div class="flex items-center justify-center w-full mt-10">
        <Action section={allLink} />
      </div>
    )
  }
</div>

<script is:inline data-astro-rerun src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>
<script data-astro-rerun is:inline>
  new Flickity('.carousel-press', {
    // options, defaults listed
    accessibility: true,
    gutter: 10,
    autoPlay: false,
    freeScroll: false,
    friction: 0.5,
    groupCells: true,
    initialIndex: 0,
    lazyLoad: true,
    prevNextButtons: true,
    pageDots: false,
    percentPosition: false,
    rightToLeft: document.dir === 'rtl',
    // wrapAround: true,
    // contain: true,
  });
</script>
